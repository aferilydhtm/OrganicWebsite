{"version":3,"file":"sc-order-confirm-provider.js","sourceRoot":"","sources":["../../../../src/components/providers/order-confirm-provider/sc-order-confirm-provider.tsx"],"names":[],"mappings":"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","sourcesContent":["import { Component, Element, Event, EventEmitter, h, Host, Listen, Prop, State } from '@stencil/core';\nimport { __ } from '@wordpress/i18n';\nimport { addQueryArgs } from '@wordpress/url';\n\nimport apiFetch from '../../../functions/fetch';\nimport { expand } from '../../../services/session';\nimport { state as checkoutState } from '@store/checkout';\nimport { Checkout, ManualPaymentMethod, Product } from '../../../types';\nimport { clearCheckout } from '@store/checkout/mutations';\nimport { maybeConvertAmount } from '../../../functions/currency';\n\n/**\n * This component listens to the order status\n * and confirms the order when payment is successful.\n */\n@Component({\n  tag: 'sc-order-confirm-provider',\n  styleUrl: 'sc-order-confirm-provider.scss',\n  shadow: true,\n})\nexport class ScOrderConfirmProvider {\n  /** The order confirm provider element */\n  @Element() el: HTMLScOrderConfirmProviderElement;\n\n  /** Whether to show success modal */\n  @State() showSuccessModal: boolean = false;\n\n  @State() confirmedCheckout: Checkout;\n\n  /** Success url. */\n  @Prop() successUrl: string;\n\n  /** Success text for the form. */\n  @Prop() successText: {\n    title: string;\n    description: string;\n    button: string;\n  };\n\n  /** The order is paid event. */\n  @Event() scOrderPaid: EventEmitter<Checkout>;\n\n  @Event() scSetState: EventEmitter<string>;\n\n  /** Error event. */\n  @Event() scError: EventEmitter<{ message: string; code?: string; data?: any; additional_errors?: any } | {}>;\n\n  /** Listen for paid event. This is triggered by Stripe or Paypal elements when payment succeeds. */\n  @Listen('scPaid')\n  handlePaidEvent() {\n    this.confirmOrder();\n  }\n\n  /** Confirm the order. */\n  async confirmOrder() {\n    try {\n      this.confirmedCheckout = (await apiFetch({\n        method: 'PATCH',\n        path: addQueryArgs(`surecart/v1/checkouts/${checkoutState?.checkout?.id}/confirm`, { expand }),\n      })) as Checkout;\n      this.scSetState.emit('CONFIRMED');\n      // emit the order paid event for tracking scripts.\n      this.scOrderPaid.emit(this.confirmedCheckout);\n      this.doGoogleAnalytics();\n    } catch (e) {\n      console.error(e);\n      this.scError.emit(e);\n    } finally {\n      // always clear the checkout.\n      clearCheckout();\n      // get success url.\n      const successUrl = this.confirmedCheckout?.metadata?.success_url || this.successUrl;\n      if (successUrl) {\n        // set state to redirecting.\n        this.scSetState.emit('REDIRECT');\n        setTimeout(() => window.location.assign(addQueryArgs(successUrl, { order: this.confirmedCheckout?.id })), 50);\n      } else {\n        this.showSuccessModal = true;\n      }\n    }\n  }\n\n  doGoogleAnalytics() {\n    if (!window?.dataLayer && !window?.gtag) return;\n\n    const data = {\n      transaction_id: this.confirmedCheckout?.id,\n      value: maybeConvertAmount(this.confirmedCheckout?.total_amount, this.confirmedCheckout?.currency || 'USD'),\n      currency: (this.confirmedCheckout.currency || '').toUpperCase(),\n      ...(this.confirmedCheckout?.discount?.promotion?.code ? { coupon: this.confirmedCheckout?.discount?.promotion?.code } : {}),\n      ...(this.confirmedCheckout?.tax_amount ? { tax: maybeConvertAmount(this.confirmedCheckout?.tax_amount, this.confirmedCheckout?.currency || 'USD') } : {}),\n      items: (this.confirmedCheckout?.line_items?.data || []).map(item => ({\n        item_name: (item?.price?.product as Product)?.name || '',\n        discount: item?.discount_amount ? maybeConvertAmount(item?.discount_amount || 0, this.confirmedCheckout?.currency || 'USD') : 0,\n        price: maybeConvertAmount(item?.price?.amount || 0, this.confirmedCheckout?.currency || 'USD'),\n        quantity: item?.quantity || 1,\n      })),\n    };\n\n    // handle gtag (analytics script.)\n    if (window?.gtag) {\n      window.gtag('event', 'purchase', data);\n    }\n\n    // handle dataLayer (google tag manager).\n    if (window?.dataLayer) {\n      window.dataLayer.push({ ecommerce: null }); // Clear the previous ecommerce object.\n      window.dataLayer.push({\n        event: 'purchase',\n        ecommerce: data,\n      });\n    }\n  }\n\n  getSuccessUrl() {\n    const url = this.confirmedCheckout?.metadata?.success_url || this.successUrl;\n    return url ? addQueryArgs(url, { order: this.confirmedCheckout?.id }) : window?.scData?.pages?.dashboard;\n  }\n\n  render() {\n    const manualPaymentMethod = this.confirmedCheckout?.manual_payment_method as ManualPaymentMethod;\n\n    return (\n      <Host>\n        <slot />\n        <sc-dialog open={!!this.showSuccessModal} style={{ '--body-spacing': 'var(--sc-spacing-xxx-large)' }} noHeader onScRequestClose={e => e.preventDefault()}>\n          <div class=\"confirm__icon\">\n            <div class=\"confirm__icon-container\">\n              <sc-icon name=\"check\" />\n            </div>\n          </div>\n          <sc-dashboard-module\n            heading={this.successText?.title || __('Thanks for your order!', 'surecart')}\n            style={{ '--sc-dashboard-module-spacing': 'var(--sc-spacing-x-large)', 'textAlign': 'center' }}\n          >\n            <span slot=\"description\">\n              {this.successText?.description || __('Your payment was successful, and your order is complete. A receipt is on its way to your inbox.', 'surecart')}\n            </span>\n            {!!manualPaymentMethod?.name && !!manualPaymentMethod?.instructions && (\n              <sc-alert type=\"info\" open style={{ 'text-align': 'left' }}>\n                <span slot=\"title\">{manualPaymentMethod?.name}</span>\n                {manualPaymentMethod?.instructions.split('\\n').map(i => {\n                  return <p>{i}</p>;\n                })}\n              </sc-alert>\n            )}\n            <sc-button href={this.getSuccessUrl()} size=\"large\" type=\"primary\">\n              {this.successText?.button || __('Continue', 'surecart')}\n              <sc-icon name=\"arrow-right\" slot=\"suffix\" />\n            </sc-button>\n          </sc-dashboard-module>\n        </sc-dialog>\n      </Host>\n    );\n  }\n}\n"]}