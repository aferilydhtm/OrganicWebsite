{"version":3,"file":"sc-cart-session-provider.js","sourceRoot":"","sources":["../../../../src/components/providers/cart-session-provider/sc-cart-session-provider.tsx"],"names":[],"mappings":"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","sourcesContent":["import { Component, Element, Event, EventEmitter, h, Listen, Prop, State, Watch } from '@stencil/core';\nimport { __ } from '@wordpress/i18n';\n\nimport { updateCheckout } from '../../../services/session';\nimport { Checkout, LineItemData } from '../../../types';\n\n@Component({\n  tag: 'sc-cart-session-provider',\n  shadow: true,\n})\nexport class ScCartSessionProvider {\n  /** Element */\n  @Element() el: HTMLElement;\n\n  /** Order Object */\n  @Prop() order: Checkout;\n\n  /** Update line items event */\n  @Event() scUpdateOrderState: EventEmitter<Checkout>;\n\n  /** Error event */\n  @Event() scError: EventEmitter<{ message: string; code?: string; data?: any; additional_errors?: any } | {}>;\n\n  /** Set the state */\n  @Event() scSetState: EventEmitter<'loading' | 'busy' | 'navigating' | 'idle'>;\n\n  /** Holds the checkout session to update. */\n  @State() session: Checkout;\n\n  /** Sync this session back to parent. */\n  @Watch('session')\n  handleSessionUpdate(val) {\n    this.scUpdateOrderState.emit(val);\n  }\n\n  @Listen('scUpdateOrder')\n  handleUpdateSession(e) {\n    const { data, options } = e.detail;\n    if (options?.silent) {\n      this.update(data);\n    } else {\n      this.loadUpdate(data);\n    }\n  }\n\n  /** Handles coupon updates. */\n  @Listen('scApplyCoupon')\n  async handleCouponApply(e) {\n    const promotion_code = e.detail;\n    this.scError.emit({});\n    this.loadUpdate({\n      discount: {\n        ...(promotion_code ? { promotion_code } : {}),\n      },\n    });\n  }\n\n  /** Handle the error response. */\n  handleErrorResponse(e) {\n    if (e?.code === 'readonly' || e?.additional_errors?.[0]?.code === 'checkout.customer.account_mismatch') {\n      this.scUpdateOrderState.emit(null);\n    }\n\n    // expired\n    if (e?.code === 'rest_cookie_invalid_nonce') {\n      this.scSetState.emit('idle');\n      return;\n    }\n\n    // something went wrong\n    if (e?.message) {\n      this.scError.emit(e);\n    }\n\n    // handle curl timeout errors.\n    if (e?.code === 'http_request_failed') {\n      this.scError.emit({ message: 'Something went wrong. Please reload the page and try again.' });\n    }\n\n    this.scSetState.emit('idle');\n  }\n\n  /** Fetch a session. */\n  async fetch(args = {}) {\n    this.loadUpdate({ status: 'draft', ...args });\n  }\n\n  /** Update a the order */\n  async update(data = {}, query = {}) {\n    try {\n      this.session = (await updateCheckout({\n        id: this.order?.id,\n        data: {\n          ...data,\n        },\n        query: {\n          ...query,\n        },\n      })) as Checkout;\n    } catch (e) {\n      console.error(e);\n      throw e;\n    }\n  }\n\n  /** Updates a session with loading status changes. */\n  async loadUpdate(data = {}) {\n    try {\n      this.scSetState.emit('busy');\n      await this.update(data);\n      this.scSetState.emit('idle');\n    } catch (e) {\n      this.handleErrorResponse(e);\n    }\n  }\n\n  render() {\n    return (\n      <sc-line-items-provider order={this.order} onScUpdateLineItems={e => this.loadUpdate({ line_items: e.detail as Array<LineItemData> })}>\n        <slot />\n      </sc-line-items-provider>\n    );\n  }\n}\n"]}