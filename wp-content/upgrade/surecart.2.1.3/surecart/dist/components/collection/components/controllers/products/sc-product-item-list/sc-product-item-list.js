import{h}from"@stencil/core";import{addQueryArgs,getQueryArgs}from"@wordpress/url";import{__}from"@wordpress/i18n";import apiFetch from"../../../../functions/fetch";export class ScProductItemList{constructor(){this.ids=void 0,this.sort="created_at:desc",this.query=void 0,this.searchEnabled=!0,this.sortEnabled=!0,this.paginationEnabled=!0,this.ajaxPagination=!0,this.paginationAutoScroll=!0,this.layoutConfig=void 0,this.paginationAlignment="center",this.limit=15,this.products=void 0,this.loading=!1,this.busy=!1,this.currentPage=1,this.currentQuery=void 0,this.pagination={total:0,total_pages:0}}componentWillLoad(){this.getProducts()}doPagination(t){if(this.ajaxPagination)return this.currentPage=t,this.updateProducts(),void(this.paginationAutoScroll&&this.el.scrollIntoView({behavior:"smooth"}));const e=addQueryArgs(location.href,{"product-page":t});window.location.replace(e)}async getProducts(){const{"product-page":t}=getQueryArgs(window.location.href);this.currentPage=this.paginationEnabled&&t?parseInt(t):1;try{this.loading=!0,await this.fetchProducts()}catch(t){console.error(t)}finally{this.loading=!1}}async handleSortChange(){this.currentPage=1,this.updateProducts()}async updateProducts(){try{this.busy=!0,await this.fetchProducts()}catch(t){console.error(t)}finally{this.busy=!1}}handleIdsChange(){null!==this.debounce&&(clearTimeout(this.debounce),this.debounce=null),this.debounce=window.setTimeout((()=>{this.updateProducts(),this.debounce=null}),200)}async fetchProducts(){var t;const e=await apiFetch({path:addQueryArgs("surecart/v1/products/",{expand:["prices","product_medias","product_media.media"],archived:!1,status:["published"],per_page:this.limit,page:this.currentPage,sort:this.sort,...(null===(t=this.ids)||void 0===t?void 0:t.length)?{ids:this.ids}:{},...this.query?{query:this.query}:{}}),parse:!1});this.currentQuery=this.query,this.pagination={total:parseInt(e.headers.get("X-WP-Total")),total_pages:parseInt(e.headers.get("X-WP-TotalPages"))},this.products=await e.json()}renderSortName(){switch(this.sort){case"created_at:desc":return __("Latest","surecart");case"created_at:asc":return __("Oldest","surecart");case"name:asc":return __("Alphabetical, A-Z","surecart");case"name:desc":return __("Alphabetical, Z-A","surecart");default:return __("Sort","surecart")}}render(){var t,e,i,a;return h("div",{class:{"product-item-list__wrapper":!0,"product-item-list__has-search":!!this.query}},(this.searchEnabled||this.sortEnabled)&&h("div",{class:"product-item-list__header"},h("div",{class:"product-item-list__sort"},this.sortEnabled&&h("sc-dropdown",{style:{"--panel-width":"15rem"}},h("sc-button",{type:"text",caret:!0,slot:"trigger"},this.renderSortName()),h("sc-menu",null,h("sc-menu-item",{onClick:()=>this.sort="created_at:desc"},__("Latest","surecart")),h("sc-menu-item",{onClick:()=>this.sort="created_at:asc"},__("Oldest","surecart")),h("sc-menu-item",{onClick:()=>this.sort="name:asc"},__("Alphabetical, A-Z","surecart")),h("sc-menu-item",{onClick:()=>this.sort="name:desc"},__("Alphabetical, Z-A","surecart"))))),h("div",{class:"product-item-list__search"},this.searchEnabled&&((null===(t=this.query)||void 0===t?void 0:t.length)&&this.query===this.currentQuery?h("div",{class:"product-item-list__search-tag"},h("div",{class:"product-item-list__search-label"},__("Search Results:","surecart")),h("sc-tag",{clearable:!0,onScClear:()=>{this.query="",this.currentQuery="",this.updateProducts()}},this.query)):h("sc-input",{type:"text",placeholder:"Search",size:"small",onKeyDown:t=>{"Enter"===t.key&&this.updateProducts()},value:this.query,onScInput:t=>this.query=t.target.value},this.query?h("sc-icon",{class:"clear-button",slot:"prefix",name:"x",onClick:()=>{this.query=""}}):h("sc-icon",{slot:"prefix",name:"search"}),h("sc-button",{class:"search-button",type:"link",slot:"suffix",busy:this.busy,onClick:()=>this.updateProducts()},__("Search","surecart")))))),!(null===(e=this.products)||void 0===e?void 0:e.length)&&!this.loading&&h("sc-empty",{class:"product-item-list__empty",icon:"shopping-bag"},__("No products found.","surecart")),h("div",{class:"product-item-list"},this.loading?[...Array((null===(i=this.ids)||void 0===i?void 0:i.length)||this.limit||10)].map((()=>{var t;return h("div",{class:"product-item-list__loader"},null===(t=this.layoutConfig)||void 0===t?void 0:t.map((t=>{var e,i;switch(t.blockName){case"surecart/product-item-title":return h("div",{style:{textAlign:"var(--sc-product-title-align)"}},h("sc-skeleton",{style:{width:"80%",display:"inline-block"}}));case"surecart/product-item-image":return h("sc-skeleton",{style:{width:"100%",minHeight:"90%",aspectRatio:null!==(i=null===(e=t.attributes)||void 0===e?void 0:e.ratio)&&void 0!==i?i:"1/1.4","--sc-border-radius-pill":"12px",display:"inline-block"}});case"surecart/product-item-price":return h("div",{style:{textAlign:"var(--sc-product-price-align)"}},h("sc-skeleton",{style:{width:"40%",display:"inline-block"}}));default:return null}})))})):(this.products||[]).map((t=>h("sc-product-item",{exportparts:"title, price, image",product:t,layoutConfig:this.layoutConfig})))),!!(null===(a=this.products)||void 0===a?void 0:a.length)&&this.pagination.total>this.products.length&&this.paginationEnabled&&h("div",{class:{"product-item-list__pagination":!0,"--is-aligned-left":"left"===this.paginationAlignment,"--is-aligned-center":"center"===this.paginationAlignment,"--is-aligned-right":"right"===this.paginationAlignment}},h("sc-pagination",{page:this.currentPage,perPage:this.limit,total:this.pagination.total,totalPages:this.pagination.total_pages,totalShowing:this.limit,onScNextPage:()=>this.doPagination(this.currentPage+1),onScPrevPage:()=>this.doPagination(this.currentPage-1)})),(this.busy||this.loading)&&h("sc-block-ui",null))}static get is(){return"sc-product-item-list"}static get encapsulation(){return"shadow"}static get originalStyleUrls(){return{$:["sc-product-item-list.scss"]}}static get styleUrls(){return{$:["sc-product-item-list.css"]}}static get properties(){return{ids:{type:"unknown",mutable:!1,complexType:{original:"string[]",resolved:"string[]",references:{}},required:!1,optional:!1,docs:{tags:[],text:"Limit to a set of ids."}},sort:{type:"string",mutable:!0,complexType:{original:"string",resolved:"string",references:{}},required:!1,optional:!1,docs:{tags:[],text:"Sort"},attribute:"sort",reflect:!1,defaultValue:"'created_at:desc'"},query:{type:"string",mutable:!0,complexType:{original:"string",resolved:"string",references:{}},required:!1,optional:!1,docs:{tags:[],text:"Query to search for"},attribute:"query",reflect:!1},searchEnabled:{type:"boolean",mutable:!1,complexType:{original:"boolean",resolved:"boolean",references:{}},required:!1,optional:!1,docs:{tags:[],text:"Should allow search"},attribute:"search-enabled",reflect:!1,defaultValue:"true"},sortEnabled:{type:"boolean",mutable:!1,complexType:{original:"boolean",resolved:"boolean",references:{}},required:!1,optional:!1,docs:{tags:[],text:"Should allow search"},attribute:"sort-enabled",reflect:!1,defaultValue:"true"},paginationEnabled:{type:"boolean",mutable:!1,complexType:{original:"boolean",resolved:"boolean",references:{}},required:!1,optional:!1,docs:{tags:[],text:"Should we paginate?"},attribute:"pagination-enabled",reflect:!1,defaultValue:"true"},ajaxPagination:{type:"boolean",mutable:!1,complexType:{original:"boolean",resolved:"boolean",references:{}},required:!1,optional:!1,docs:{tags:[],text:"Should we paginate?"},attribute:"ajax-pagination",reflect:!1,defaultValue:"true"},paginationAutoScroll:{type:"boolean",mutable:!1,complexType:{original:"boolean",resolved:"boolean",references:{}},required:!1,optional:!1,docs:{tags:[],text:"Should we auto-scroll to the top when paginating via ajax"},attribute:"pagination-auto-scroll",reflect:!1,defaultValue:"true"},layoutConfig:{type:"unknown",mutable:!1,complexType:{original:"LayoutConfig",resolved:"{ blockName: string; attributes: any; }[]",references:{LayoutConfig:{location:"local",path:"/home/runner/work/surecart-wp/surecart-wp/packages/components/src/components/controllers/products/sc-product-item-list/sc-product-item-list.tsx"}}},required:!1,optional:!1,docs:{tags:[],text:""}},paginationAlignment:{type:"string",mutable:!1,complexType:{original:"string",resolved:"string",references:{}},required:!1,optional:!1,docs:{tags:[],text:""},attribute:"pagination-alignment",reflect:!1,defaultValue:"'center'"},limit:{type:"number",mutable:!1,complexType:{original:"number",resolved:"number",references:{}},required:!1,optional:!1,docs:{tags:[],text:""},attribute:"limit",reflect:!1,defaultValue:"15"}}}static get states(){return{products:{},loading:{},busy:{},currentPage:{},currentQuery:{},pagination:{}}}static get elementRef(){return"el"}static get watchers(){return[{propName:"sort",methodName:"handleSortChange"},{propName:"ids",methodName:"handleIdsChange"},{propName:"limit",methodName:"handleIdsChange"}]}}