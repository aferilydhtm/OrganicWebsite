import{r as i,h as t}from"./p-25a9e68f.js";import{U as o}from"./p-8dcbcebb.js";import{c as s}from"./p-afcbd440.js";import{c as r}from"./p-62338837.js";import{g as e,s as n}from"./p-b6ef0098.js";import{s as d}from"./p-ffdee0af.js";import"./p-61ab3f3a.js";import"./p-4c5e6c8d.js";import"./p-db7ede86.js";import"./p-7c27060f.js";import"./p-6c2a2148.js";import"./p-d8453138.js";import"./p-1c2e2695.js";import"./p-4d73f82a.js";const l={expand:["line_items","line_item.price","price.product","customer","customer.shipping_address","payment_intent","discount","discount.promotion","discount.coupon","shipping_address","tax_identifier"]};const a=class{constructor(t){i(this,t);this.quantity=1;this.priceId=undefined;this.mode="live";this.formId=undefined;this.order=undefined;this.busy=undefined;this.error=undefined}getLineItem(){var i,t;const o=this.getOrder();const s=(((i=o===null||o===void 0?void 0:o.line_items)===null||i===void 0?void 0:i.data)||[]).find((i=>{var t;return((t=i.price)===null||t===void 0?void 0:t.id)===this.priceId}));if(!(s===null||s===void 0?void 0:s.id)){return false}return{id:s===null||s===void 0?void 0:s.id,price_id:(t=s===null||s===void 0?void 0:s.price)===null||t===void 0?void 0:t.id,quantity:s===null||s===void 0?void 0:s.quantity}}getOrder(){return e(this===null||this===void 0?void 0:this.formId,this.mode)}async addToCart(){const{price:i}=await this.form.getFormJson();try{this.busy=true;const t=await this.addOrUpdateLineItem({...!!i?{ad_hoc_amount:parseInt(i)||null}:{}});n(t,this.formId);d.set("cart",{...d.state.cart,...{open:true}})}catch(i){console.error(i);this.error=(i===null||i===void 0?void 0:i.message)||wp.i18n.__("Something went wrong","surecart")}finally{this.busy=false}}async addOrUpdateLineItem(i={}){var t,o;let e=this.getLineItem();let n=s(((t=this.getOrder())===null||t===void 0?void 0:t.line_items)||[]);return await r({id:(o=this.getOrder())===null||o===void 0?void 0:o.id,data:{live_mode:this.mode==="live",line_items:[...(n||[]).map((t=>{if(this.priceId===(t===null||t===void 0?void 0:t.price_id)){return{...t,...!!(i===null||i===void 0?void 0:i.ad_hoc_amount)?{ad_hoc_amount:i===null||i===void 0?void 0:i.ad_hoc_amount}:{},quantity:!(t===null||t===void 0?void 0:t.ad_hoc_amount)?(t===null||t===void 0?void 0:t.quantity)+1:1}}return t})),...!e?[{price_id:this.priceId,...!!(i===null||i===void 0?void 0:i.ad_hoc_amount)?{ad_hoc_amount:i===null||i===void 0?void 0:i.ad_hoc_amount}:{},quantity:1}]:[]]},query:{...l,form_id:this.formId}})}componentWillLoad(){o.create(this,this.state())}state(){return{busy:this.busy,error:this.error,order:this.getOrder()}}render(){return t("sc-form",{ref:i=>this.form=i,onScSubmit:()=>{this.addToCart()}},this.error&&t("sc-alert",{open:!!this.error,type:"danger"},t("span",{slot:"title"},wp.i18n.__("Error","surecart")),this.error),t(o.Provider,{state:this.state()},t("slot",null)))}};a.style="sc-cart-form { display: inline-block }";export{a as sc_cart_form};
//# sourceMappingURL=p-ab371195.entry.js.map