{"file":"sc-cart-form.js","mappings":";;;;;;;;;;AAUA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;wEAyEiC,UAAE;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;6GAwEH,UAAE;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;","names":[],"sources":["./src/components/controllers/cart/sc-cart-form/sc-cart-form.tsx"],"sourcesContent":["import { Component, h, Prop, State } from '@stencil/core';\nimport { __ } from '@wordpress/i18n';\nimport { Creator, Universe } from 'stencil-wormhole';\n\nimport { convertLineItemsToLineItemData } from '../../../../functions/line-items';\nimport { createOrUpdateCheckout } from '../../../../services/session';\nimport { getOrder, setOrder } from '@store/checkouts';\nimport uiStore from '@store/ui';\nimport { Checkout, LineItemData } from '../../../../types';\n\nconst query = {\n  expand: [\n    'line_items',\n    'line_item.price',\n    'price.product',\n    'customer',\n    'customer.shipping_address',\n    'payment_intent',\n    'discount',\n    'discount.promotion',\n    'discount.coupon',\n    'shipping_address',\n    'tax_identifier',\n  ],\n};\n\n@Component({\n  tag: 'sc-cart-form',\n  styles: 'sc-cart-form { display: inline-block }',\n  shadow: false,\n})\nexport class ScCartForm {\n  private form: HTMLScFormElement;\n\n  /** The quantity */\n  @Prop({ mutable: true }) quantity: number = 1;\n\n  /** The price id to add. */\n  @Prop() priceId: string;\n\n  /** Are we in test or live mode. */\n  @Prop() mode: 'test' | 'live' = 'live';\n\n  /** The form id to use for the cart. */\n  @Prop({ reflect: true }) formId: string;\n\n  @State() order: Checkout;\n\n  /** Is it busy */\n  @State() busy: boolean;\n  @State() error: string;\n\n  /** Find a line item with this price. */\n  getLineItem() {\n    const order = this.getOrder();\n    const lineItem = (order?.line_items?.data || []).find(item => item.price?.id === this.priceId);\n    if (!lineItem?.id) {\n      return false;\n    }\n\n    return {\n      id: lineItem?.id,\n      price_id: lineItem?.price?.id,\n      quantity: lineItem?.quantity,\n    } as LineItemData;\n  }\n\n  getOrder() {\n    return getOrder(this?.formId, this.mode);\n  }\n\n  /** Add the item to cart. */\n  async addToCart() {\n    const { price } = await this.form.getFormJson();\n    try {\n      this.busy = true;\n      // if it's ad_hoc, update the amount. Otherwise increment the quantity.\n      const order = await this.addOrUpdateLineItem({ ...(!!price ? { ad_hoc_amount: parseInt(price as string) || null } : {}) });\n      // store the checkout in localstorage and open the cart\n      setOrder(order, this.formId);\n      uiStore.set('cart', { ...uiStore.state.cart, ...{ open: true } });\n    } catch (e) {\n      console.error(e);\n      this.error = e?.message || __('Something went wrong', 'surecart');\n    } finally {\n      this.busy = false;\n    }\n  }\n\n  async addOrUpdateLineItem(data: any = {}) {\n    // get the current line item from the price id.\n    let lineItem = this.getLineItem() as LineItemData;\n\n    // convert line items response to line items post.\n    let existingData = convertLineItemsToLineItemData(this.getOrder()?.line_items || []);\n\n    // Line item does not exist. Add it.\n    return (await createOrUpdateCheckout({\n      id: this.getOrder()?.id,\n      data: {\n        live_mode: this.mode === 'live',\n        line_items: [\n          ...(existingData || []).map((item: LineItemData) => {\n            // if the price ids match (we have already a line item)\n            if (this.priceId === item?.price_id) {\n              return {\n                ...item,\n                ...(!!data?.ad_hoc_amount ? { ad_hoc_amount: data?.ad_hoc_amount } : {}),\n                quantity: !item?.ad_hoc_amount ? item?.quantity + 1 : 1, // only increase quantity if not ad_hoc.\n              };\n            }\n            // return item.\n            return item;\n          }),\n          // add a line item if one does not exist.\n          ...(!lineItem\n            ? [\n                {\n                  price_id: this.priceId,\n                  ...(!!data?.ad_hoc_amount ? { ad_hoc_amount: data?.ad_hoc_amount } : {}),\n                  quantity: 1,\n                },\n              ]\n            : []),\n        ],\n      },\n      query: {\n        ...query,\n        form_id: this.formId,\n      },\n    })) as Checkout;\n  }\n\n  componentWillLoad() {\n    Universe.create(this as Creator, this.state());\n  }\n\n  state() {\n    return {\n      busy: this.busy,\n      error: this.error,\n      order: this.getOrder(),\n    };\n  }\n\n  render() {\n    return (\n      <sc-form\n        ref={el => (this.form = el as HTMLScFormElement)}\n        onScSubmit={() => {\n          this.addToCart();\n        }}\n      >\n        {this.error && (\n          <sc-alert open={!!this.error} type=\"danger\">\n            <span slot=\"title\">{__('Error', 'surecart')}</span>\n            {this.error}\n          </sc-alert>\n        )}\n        <Universe.Provider state={this.state()}>\n          <slot />\n        </Universe.Provider>\n      </sc-form>\n    );\n  }\n}\n"],"version":3}